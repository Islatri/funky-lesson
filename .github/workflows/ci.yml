name: CI/CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  CARGO_TERM_COLOR: always
  TRUNK_VERSION: 0.21.4
  TAURI_CLI_VERSION: 2.8.4

jobs:
  quality:
    name: Quality & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - name: Install Linux deps
        run: sudo apt-get update && sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev

      - name: Format & Check
        run: |
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets -- -D clippy::correctness -D clippy::suspicious -W clippy::complexity
          cargo check --workspace

      - name: Test
        run: cargo test --workspace

  build-desktop:
    name: Desktop Build
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/v')
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest' 
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Cache trunk binary
        id: cache-trunk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/trunk
          key: trunk-${{ runner.os }}-${{ env.TRUNK_VERSION }}

      - name: Install trunk
        if: steps.cache-trunk.outputs.cache-hit != 'true'
        run: |
          cargo install --version ${{ env.TRUNK_VERSION }} trunk --locked

      - name: Build frontend
        run: trunk build --release

      - uses: tauri-apps/tauri-action@v0.5.23
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.args }}

  # ğŸ” Android æ„å»º - åŒ…å«ç­¾åé…ç½®
  build-android:
    name: Android Build  
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/v')
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cache-disabled: false

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Rust cache
        uses: swatinem/rust-cache@v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache Android NDK
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_HOME }}/ndk
          key: android-ndk-26.3.11579264

      - name: Cache build tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/trunk
            ~/.cargo/bin/cargo-tauri
          key: build-tools-${{ runner.os }}-trunk-${{ env.TRUNK_VERSION }}-tauri-${{ env.TAURI_CLI_VERSION }}

      - name: Install NDK
        run: sdkmanager "ndk;26.3.11579264"

      - name: Install tools
        run: |
          if [ ! -f ~/.cargo/bin/trunk ]; then
            cargo install --version ${{ env.TRUNK_VERSION }} trunk --locked
          fi
          if [ ! -f ~/.cargo/bin/cargo-tauri ]; then
            cargo install --version ${{ env.TAURI_CLI_VERSION }} tauri-cli --locked
          fi

      - name: Build frontend
        run: trunk build --release

      # ğŸ” é…ç½® Android ç­¾å
      - name: Setup Android signing
        run: |
          # åˆ›å»º keystore ç›®å½•
          mkdir -p ${{ github.workspace }}/android-signing
          
          # ä» Secrets ä¸­è§£ç å¹¶ä¿å­˜ keystore æ–‡ä»¶
          echo "${{ secrets.ANDROID_KEYSTORE_FILE }}" | base64 --decode > ${{ github.workspace }}/android-signing/app-release.jks
          
          # åˆ›å»º key.properties æ–‡ä»¶
          cat << EOF > ${{ github.workspace }}/src-tauri/gen/android/key.properties
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=${{ github.workspace }}/android-signing/app-release.jks
          EOF

      # ğŸ—ï¸ æ„å»ºç­¾åçš„ APK
      - name: Build Android APK (Release & Signed)
        run: |
          # æ„å»º release APK (ä¼šè‡ªåŠ¨ä½¿ç”¨ key.properties è¿›è¡Œç­¾å)
          cargo tauri android build --apk --release
        env:
          CARGO_INCREMENTAL: 1

      # ğŸ—ï¸ æ„å»º AAB (Google Play å‘å¸ƒæ ¼å¼)
      - name: Build Android AAB (Release & Signed)
        run: |
          # æ„å»º AAB æ ¼å¼ (Google Play æ¨è)
          cargo tauri android build --aab --release
        env:
          CARGO_INCREMENTAL: 1

      # ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-signed
          path: src-tauri/gen/android/app/build/outputs/apk/release/*.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-signed
          path: src-tauri/gen/android/app/build/outputs/bundle/release/*.aab

      # ğŸ§¹ æ¸…ç†æ•æ„Ÿæ–‡ä»¶
      - name: Cleanup signing files
        if: always()
        run: |
          rm -rf ${{ github.workspace }}/android-signing
          rm -f ${{ github.workspace }}/src-tauri/gen/android/key.properties

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v') 
    needs: [build-desktop, build-android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            **/*
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}